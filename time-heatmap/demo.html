<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>time x heatmap</title>
    <script src='https://unpkg.com/maplibre-gl@2.1.9/dist/maplibre-gl.js'></script>
    <link  href='https://unpkg.com/maplibre-gl@2.1.9/dist/maplibre-gl.css' rel='stylesheet'/>
    <style>
html, body, #map {height: 100%; width: 100%; padding: 0; margin: 0; overflow: hidden }
#data { display: none }
.range { padding: 8px; margin: 8px }
.range input { width: 50vw }
    </style>
  </head>
  <body>
    <div id='map'></map>
  <script type='text/javascript'>
// config
const config = {
  url_csv: 'data/viirs-snpp_2021_Spain.csv',
  map: {
    container: 'map',
    style: 'https://demotiles.maplibre.org/style.json',
    center: [ -5, 40],
    zoom: 5,
    'customAttribution': 'MapLibre, FIRMS(NASA)',
    'maplibreLogo': true,
    'maxBounds': [[-25, 30],[15, 50]],
    'minZoom': 4
  },
  source_points: {
    type: 'geojson',
    data: null
  },
  range_heatmap: 6,
  layer_heatmap: {
    id: 'heatmap',
    type: 'heatmap',
    source: 'points',
    paint: {
      'heatmap-weight': [
        'interpolate',
        ['linear'], ['get', 'bright_ti4'],
        0, 0, 6, 1
      ],
      'heatmap-intensity': [
        'interpolate',
        ['linear'], ['zoom'],
        0, 0, 9, 1
      ],
      'heatmap-color': [
        'interpolate',
        ['linear'], ['heatmap-density'],
        0,   'rgba(33,102,172,0)',
        0.2, 'rgb(103,169,207)',
        0.4, 'rgb(209,229,240)',
        0.6, 'rgb(253,219,199)',
        0.8, 'rgb(239,138,98)',
        1,   'rgb(178,24,43)'
      ],
      'heatmap-radius': [
        'interpolate',
        ['linear'], ['zoom'],
        0, 1, 9, 20
      ],
      'heatmap-opacity': [
        'interpolate',
        ['linear'], ['zoom'],
        7, 1, 9, 0.5
      ]
    }
  },
}

class rangeControl {
  constructor(props) {
    this.props = props
    this.min = Math.min(...props.geoj.features.map(f=>f.properties._d)) + props.rangew,
    this.max = Math.max(...props.geoj.features.map(f=>f.properties._d)),
    this.conv = d => (new Date(d*24*60*60*1000)).toISOString().slice(0,10)
    this.disp = (a, b) => [this.conv(a - props.rangew), this.conv(b)].join(" - ")
  }
  onAdd(map) {
    this._map = map
    this._container = document.createElement('div')
    this._container.className += 'range mapboxgl-ctrl'
    const input = document.createElement('input')
    const label = document.createElement('label')
    input.type = 'range'
    input.setAttribute('id', 'range')
    input.setAttribute('min', this.min || 0)
    input.setAttribute('max', this.max || 0)
    input.setAttribute('step', 1)
    input.setAttribute('value', this.min || 0)
    label.style.cssText = 'background: #eee'
    label.innerText = this.disp(this.min, this.max)
    label.setAttribute('for', 'range')
    this._container.appendChild(input)
    this._container.appendChild(label)
    input.addEventListener('input', event => {
      const t = event.target.value
      label.innerText = this.disp(t, t)
      map.getSource('points').setData({
        type: 'FeatureCollection',
        features: this.props.geoj.features.filter(f=>((t - this.props.rangew)<=f.properties._d)&&(f.properties._d<=t))
      })
    })
    return this._container
  }
  onRemove() {
    this._container.parentNode.removeChild(this._container);
    this._map = undefined;
  }
}

const loadcsv = url => {
  return window.fetch(url).then(r=>r.text()).then(txt=>{
    const rows = txt.split("\n").filter(l=>l!='')
    const t = a => a.split(',').map(b=>b.trim())
    const header = t(rows.shift())
    const ilat = header.reduce((a,b,i)=>b.match(/latitude/i)?i:a,  '')
    const ilng = header.reduce((a,b,i)=>b.match(/longitude/i)?i:a, '')
    const iacq = header.reduce((a,b,i)=>b.match(/acq_date/i)?i:a,  '')
    return {
      type: 'FeatureCollection',
      features: rows.map((row, i)=>({
        type: 'Feature',
        properties: {
          ...Object.fromEntries(t(row).map((a,i)=>[header[i],a.match(/^-?[0-9.]+$/)?parseFloat(a):a])),
          _d: (new Date(t(row)[iacq])).getTime()/(24*60*60*1000)
        },
        geometry: {
          type: 'Point',
          coordinates: [t(row)[ilng], t(row)[ilat]]
        }
      }))
    }
  })
}

// process
const map = new maplibregl.Map(config.map)

map.on('load', async () => {
  map.addSource('points', config.source_points)
  map.addLayer(config.layer_heatmap)
  const geoj = await loadcsv(config.url_csv)
  map.addControl(new rangeControl({
    geoj: geoj,
    rangew: config.range_heatmap
  }), 'top-left')
  map.getSource('points').setData({ type: 'FeatureCollection', features: geoj.features })
})
  </script>
  </body>
</html>